#%Module
# singularity

proc ModulesHelp { } {
   puts stderr "Provide a user environment suitable for running Singularity containers"
}
module-whatis "Provide a user environment suitable for running Singularity containers"

set appname singularity
set machine titan
set version 2.3.1

# Ensure that the correct environment variables are picked up in the container
# assuming TitanPrep.sh has been run on the image

if { [ is-loaded PrgEnv-pgi ] } {
  module swap PrgEnv-pgi PrgEnv-gnu
}
if { [ is-loaded PrgEnv-intel ] } {
  module swap PrgEnv-intel PrgEnv-gnu
}
if { [ is-loaded PrgEnv-cray ] } {
  module swap PrgEnv-cray PrgEnv-gnu
}
module swap gcc gcc/4.9.3

# Unset a few variables within the container
setenv SINGULARITYENV_PYTHONSTARTUP ""
setenv SINGULARITYENV_PKG_CONFIG_PATH ""

# Inject Cray's MPI libs using dl_intercept
setenv SINGULARITYENV_LD_AUDIT "/sw/xk6/singularity/lib/libdl-intercept.so"
setenv SINGULARITYENV_RTLD_SUBSTITUTIONS "/sw/xk6/singularity/rtld.sub"

# These are needed to keep Cray PMI happy when LD_PRELOAD'ing MPI libraries
setenv PMI_NO_FORK 1
setenv PMI_NO_PREINITIALIZE 1

setenv SINGULARITYENV_MODULE_LOADED 1
#
##-- end
#

